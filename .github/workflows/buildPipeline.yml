# This is a basic workflow to help you get started with Actions

name: Build and test

# Controls when the workflow will run
on:
  # Triggers the workflow on pull request events but only for the "master" branch
  pull_request:
    branches: [ "master" ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  # This job tests running on hardware with a custom path to libdcap_quoteprov.so
  ACCTest:          
    strategy:
      # Launch a VM and build once per each combination of linux image and buildType
      max-parallel: 2
      matrix:
        image: ["Canonical:0001-com-ubuntu-server-focal:20_04-lts-gen2:latest", "Canonical:UbuntuServer:18_04-lts-gen2:latest"]
        buildType: [RelWithDebInfo, Debug]
        include:
          - image: "Canonical:0001-com-ubuntu-server-focal:20_04-lts-gen2:latest"
            imageVmName: Ubuntu20_04
          - image: "Canonical:UbuntuServer:18_04-lts-gen2:latest"
            imageVmName: Ubuntu18_04
            
    # OS of the Github VM calling Azure CLI
    runs-on: ubuntu-latest
    
    # Job environment variables
    env:
      vmName: dcapACCTestBuildVM${{ github.run_number }}${{ matrix.imageVmName }}${{ matrix.buildType }}
      rgName: dcap-github-actions-agents-rg

      
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      # Runs a single command using the runners shell
      # - name: Run a one-line script
      #   run: echo $vmName

      # Runs a set of commands using the runners shell
      # - name: Run a multi-line script
      #   run: |
      #     echo Add other actions to build,
      #     echo test, and deploy your project.
          
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Create VM
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm create \
              --resource-group $rgName \
              --name $vmName \
              --image ${{ matrix.image }} \
              --size Standard_DC4s_v2 \
              --admin-username ${{ secrets.BUILD_VM_USERNAME }} \
              --admin-password ${{ secrets.BUILD_VM_PASSWORD }} \
              --nic-delete-option delete \
              --os-disk-delete-option delete \
              --public-ip-sku Standard
      
      - name: Sleep to let the VM start
        run: sleep 60
              
      - name: Install software properties common
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installSoftwarePropertiesCommon" \
              --script "sudo apt install software-properties-common -y  && echo $?" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installSoftwarePropertiesCommon" \
              --instance-view
              
      - name: Add ppa repository
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "addPpaRepository" \
              --script "sudo add-apt-repository ppa:team-xbmc/ppa -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "addPpaRepository" \
              --instance-view
              
      - name: Update apt-get
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "updateAptGet" \
              --script "sudo apt-get update -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "updateAptGet" \
              --instance-view
              
      - name: Install libSSL
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installLibSSL" \
              --script "sudo apt-get install libssl-dev -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installLibSSL" \
              --instance-view    
              
      - name: Install openSSL
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installOpenSSL" \
              --script "sudo apt install libcurl4-openssl-dev -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installOpenSSL" \
              --instance-view    
              
      - name: Install PkgConfig
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installPkgConfig" \
              --script "sudo apt-get install pkg-config -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installPkgConfig" \
              --instance-view    
              
      - name: Install buildEssential
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installBuildEssential" \
              --script "sudo apt install build-essential -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installBuildEssential" \
              --instance-view
              
      - name: Install nlohmann json
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installNlohmannJson" \
              --script "sudo apt-get install nlohmann-json3-dev -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installNlohmannJson" \
              --instance-view
              
      - name: Install sqlite3
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installSqlite3" \
              --script "sudo apt-get install sqlite3 -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installSqlite3" \
              --instance-view    
              
      - name: Install sqlite3 dev
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installSqlite3Dev" \
              --script "sudo apt-get install libsqlite3-dev -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installSqlite3Dev" \
              --instance-view        
              
      - name: Install CMake
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installCMake" \
              --script "sudo apt-get install cmake -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installCMake" \
              --instance-view
              
      - name: Clone Azure DCAP 
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "cloneAzureDcap" \
              --script "git clone -b ${{ github.head_ref }} https://github.com/microsoft/Azure-DCAP-Client.git /AzureDCAP" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "cloneAzureDcap" \
              --instance-view
              
      - name: Update DCAP submodule
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "updateSubmodule" \
              --script "cd /AzureDCAP && git submodule update --init --recursive" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "updateSubmodule" \
              --instance-view    
              
      - name: Configure Azure DCAP
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "configureAzureDcap" \
              --script "cd /AzureDCAP/src/Linux && ./configure" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "configureAzureDcap" \
              --instance-view    
              
      - name: Make Azure DCAP
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeAzureDcap" \
              --script "cd /AzureDCAP/src/Linux && make" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeAzureDcap" \
              --instance-view    
                            
      - name: Clone openenclave 
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "cloneOpenEnclave" \
              --script "git clone --recursive https://github.com/openenclave/openenclave.git /openenclave" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "cloneOpenEnclave" \
              --instance-view 
                            
      - name: Update openenclave submodule
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "updateOpenEnclaveSubmodule" \
              --script "mkdir /openenclave/build && cd /openenclave/build && git submodule update --recursive --init" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "updateOpenEnclaveSubmodule" \
              --instance-view
                            
      - name: Install Ansible
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installAnsible" \
              --script "cd /openenclave && sudo scripts/ansible/install-ansible.sh" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installAnsible" \
              --instance-view
                            
      - name: Setup ACC 
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "setupACC" \
              --script "cd /openenclave && sudo ansible-playbook scripts/ansible/oe-contributors-acc-setup.yml" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "setupACC" \
              --instance-view
                            
      - name: CMake openenclave with ninja
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "cmakeOpenEnclave" \
              --script "cd /openenclave/build && cmake /openenclave -G Ninja -DCMAKE_BUILD_TYPE=${{ matrix.buildType }}" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "cmakeOpenEnclave" \
              --instance-view
                            
      - name: Make openenclave with ninja
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeOpenEnclave" \
              --script "cd /openenclave/build && ninja -v" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeOpenEnclave" \
              --instance-view
                            
      - name: Run openenclave tests
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "testOpenEnclave" \
              --script "cd /openenclave/build && LD_LIBRARY_PATH=/AzureDCAP/src/Linux ctest --output-on-failure" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "testOpenEnclave" \
              --instance-view

      - name: Cleanup
        if: always()
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm delete \
              -g $rgName \
              -n $vmName \
              --yes
            az resource delete \
              -g $rgName \
              -n ${{ env.vmName }}NSG \
              --resource-type "Microsoft.Network/networkSecurityGroups"
            az resource delete \
              -g $rgName \
              -n ${{ env.vmName }}PublicIP \
              --resource-type "Microsoft.Network/publicIPAddresses"
              
  # This job runs DCAP end to end tests 
  DCAPE2ETest:
            
    # OS of the Github VM calling Azure CLI
    runs-on: ubuntu-latest
    
    # Job environment variables
    env:
      vmName: dcapE2ETestBuildVM${{ github.run_number }}Ubuntu20_04
      rgName: dcap-github-actions-agents-rg

      
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
          
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
            
      - name: Create VM
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm create \
              --resource-group $rgName \
              --name $vmName \
              --image "Canonical:0001-com-ubuntu-server-focal:20_04-lts-gen2:latest" \
              --size Standard_DC4s_v2 \
              --admin-username ${{ secrets.BUILD_VM_USERNAME }} \
              --admin-password ${{ secrets.BUILD_VM_PASSWORD }} \
              --nic-delete-option delete \
              --os-disk-delete-option delete \
              --public-ip-sku Standard
              
      - name: Sleep to let the VM start
        run: sleep 60
              
      - name: Update apt-get
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "updateAptGet" \
              --script "sudo apt-get update -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "updateAptGet" \
              --instance-view
              
      - name: Install libSSL
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installLibSSL" \
              --script "sudo apt-get install libssl-dev -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installLibSSL" \
              --instance-view    
              
      - name: Install openSSL
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installOpenSSL" \
              --script "sudo apt install libcurl4-openssl-dev -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installOpenSSL" \
              --instance-view    
              
      - name: Install PkgConfig
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installPkgConfig" \
              --script "sudo apt-get install pkg-config -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installPkgConfig" \
              --instance-view    
              
      - name: Install buildEssential
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installBuildEssential" \
              --script "sudo apt install build-essential -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installBuildEssential" \
              --instance-view    
              
      - name: Install nlohmann json
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installNlohmannJson" \
              --script "sudo apt-get install nlohmann-json3-dev -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installNlohmannJson" \
              --instance-view    
              
      - name: Install sqlite3
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installSqlite3" \
              --script "sudo apt-get install sqlite3 -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installSqlite3" \
              --instance-view    
              
      - name: Install sqlite3 dev
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installSqlite3Dev" \
              --script "sudo apt-get install libsqlite3-dev -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installSqlite3Dev" \
              --instance-view    
              
      - name: Install libgtest
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installLibgtest" \
              --script "sudo apt-get install libgtest-dev -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installLibgtest" \
              --instance-view    
              
      - name: Install CMake
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installCMake" \
              --script "sudo apt-get install cmake -y" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installCMake" \
              --instance-view    
              
      - name: Install Google test
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installGoogleTest" \
              --script "cd /usr/src/gtest && sudo cmake CMakeLists.txt && sudo make && cd lib && sudo cp *.a /usr/lib" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "installGoogleTest" \
              --instance-view
              
      - name: Clone Azure DCAP 
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "cloneAzureDcap" \
              --script "git clone -b ${{ github.head_ref }} https://github.com/microsoft/Azure-DCAP-Client.git /AzureDCAP" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "cloneAzureDcap" \
              --instance-view
              
      - name: Update submodule
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "updateSubmodule" \
              --script "cd /AzureDCAP && git submodule update --init --recursive" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "updateSubmodule" \
              --instance-view    
              
      - name: Configure Azure DCAP
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "configureAzureDcap" \
              --script "cd /AzureDCAP/src/Linux && ./configure" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "configureAzureDcap" \
              --instance-view    
              
      - name: Make Azure DCAP
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeAzureDcap" \
              --script "cd /AzureDCAP/src/Linux && make" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeAzureDcap" \
              --instance-view    
              
      - name: Make Install Azure DCAP
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeInstallAzureDcap" \
              --script "cd /AzureDCAP/src/Linux && sudo make install" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeInstallAzureDcap" \
              --instance-view      
              
      - name: CMake DCAP tests
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "cmakeDcapTests" \
              --script "cd /AzureDCAP/src/Linux && cmake CMakeLists.txt" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "cmakeDcapTests" \
              --instance-view      
              
      - name: Make DCAP tests
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeDcapTests" \
              --script "cd /AzureDCAP/src/Linux/ext/intel/ && sudo cp * /usr/include/ && cd ../.. && make" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeDcapTests" \
              --instance-view        
              
      - name: Get make version
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeVersion" \
              --script "make -v" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeVersion" \
              --instance-view         
              
      - name: Get g++ version
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeVersion" \
              --script "ls -l /usr/bin/g++*" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "makeVersion" \
              --instance-view      
              
      - name: Run DCAP tests
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm run-command create \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "runDcapTests" \
              --script "cd /AzureDCAP/src/Linux && sudo /sbin/ldconfig -v && ./dcap_provider_utests" 
            az vm run-command show \
              --resource-group $rgName \
              --vm-name $vmName \
              --name "runDcapTests" \
              --instance-view

      - name: Cleanup
        if: always()
        uses: azure/CLI@v1
        with:
          inlineScript: |
            az vm delete \
              -g $rgName \
              -n $vmName \
              --yes
            az resource delete \
              -g $rgName \
              -n ${{ env.vmName }}NSG \
              --resource-type "Microsoft.Network/networkSecurityGroups"
            az resource delete \
              -g $rgName \
              -n ${{ env.vmName }}PublicIP \
              --resource-type "Microsoft.Network/publicIPAddresses"
              

      
